import redis from "../db/redis.js"

/* ================= TOGGLE LIKE ================= */
export const toggleLike = async (req, res) => {
  const postId = req.params.postId
  const userId = req.user.user_id

  const likeKey = `post:likes:${postId}`
  const userSet = `post:liked_users:${postId}`

  try {
    const alreadyLiked = await redis.sIsMember(userSet, userId.toString())

    let liked

    if (alreadyLiked) {
      await redis.sRem(userSet, userId.toString())
      await redis.decr(likeKey)
      liked = false
    } else {
      await redis.sAdd(userSet, userId.toString())
      await redis.incr(likeKey)
      liked = true
    }

    // ⭐ บอก worker ว่าต้อง sync DB
    await redis.sAdd("dirty:posts", postId)

    const totalLikes = await redis.get(likeKey)

    res.json({
      liked,
      likes: Number(totalLikes || 0)
    })

  } catch (err) {
    console.error(err)
    res.status(500).json({ error: "like failed" })
  }
}